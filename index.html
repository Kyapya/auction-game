<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>オークション (Safe Mode)</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
/* デザイン設定 */
:root { --bg: #2d5e2e; --primary: #f39c12; --danger: #e74c3c; --blue: #3498db; }
body {
    font-family: sans-serif; background: var(--bg); color: white; margin: 0; padding: 0;
    height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
    user-select: none; -webkit-user-select: none;
}
#container { flex: 1; display: flex; flex-direction: column; padding: 5px; max-width: 600px; margin: 0 auto; width: 100%; box-sizing: border-box; }

/* 画面 */
.screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
.hidden { display: none !important; }

/* ボタン類 */
h1 { color: var(--primary); font-size: 2.5rem; margin-bottom: 20px; }
button { cursor: pointer; }
.btn-lg { padding: 15px 30px; font-size: 1.2rem; border: none; border-radius: 50px; margin: 10px; width: 80%; max-width: 300px; font-weight: bold; color: #fff; }
.btn-cpu { background: var(--primary); }
.btn-online { background: var(--blue); }

/* ゲーム内要素 */
.card { width: 45px; height: 64px; background: white; color: black; border-radius: 4px; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 1.1rem; border: 1px solid #999; margin: 2px; }
.card.back { background: repeating-linear-gradient(45deg, #606dbc, 10px, #465298 10px, #465298 20px); color: transparent; }
.card.selected { border: 3px solid #f1c40f; transform: translateY(-10px); }
.hand-area { display: flex; flex-wrap: wrap; justify-content: center; min-height: 70px; }
.field-row { display: flex; justify-content: space-between; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 5px; margin: 5px 0; flex: 1; }
.col-bid { width: 40%; display: flex; flex-direction: column; align-items: center; }
.col-center { width: 20%; display: flex; flex-direction: column; align-items: center; font-size: 0.8rem; }
#controls { display: flex; gap: 5px; padding: 5px; }
.act-btn { flex: 1; padding: 15px; border: none; border-radius: 5px; font-weight: bold; color: white; font-size: 1rem; }
#log { height: 60px; overflow-y: auto; background: rgba(0,0,0,0.5); font-size: 0.8rem; padding: 5px; }
#debug-msg { color: #e74c3c; background: #fff; padding: 5px; border-radius: 4px; font-size: 0.8rem; margin-top: 10px; display: none; }
</style>
</head>
<body>

<div id="screen-title" class="screen">
    <h1>AUCTION</h1>
    <button class="btn-lg btn-cpu" onclick="startCpuMode()">ひとりで遊ぶ</button>
    <button class="btn-lg btn-online" onclick="startOnlineMode()">友達と遊ぶ</button>
    <div id="debug-msg"></div>
</div>

<div id="screen-lobby" class="screen hidden">
    <h2>オンライン設定</h2>
    <input type="text" id="room-id" placeholder="部屋ID (例: 1234)" style="font-size:1.2rem; padding:10px; text-align:center; margin:10px;">
    <div>
        <button class="btn-lg btn-cpu" onclick="createRoom()">部屋を作る</button>
        <button class="btn-lg btn-online" onclick="joinRoom()">部屋に入る</button>
    </div>
    <p id="lobby-status" style="color:#f1c40f; margin-top:10px;"></p>
    <button onclick="location.reload()" style="margin-top:20px; padding:10px; background:none; border:1px solid white; color:white;">戻る</button>
</div>

<div id="container" class="hidden">
    <button onclick="location.reload()" style="position:absolute; top:5px; left:5px; z-index:10;">TOP</button>
    
    <div style="text-align:center; font-size:0.8rem;">相手: <span id="p2-name">...</span></div>
    <div class="hand-area" id="p2-hand"></div>

    <div class="field-row">
        <div class="col-bid"><div>相手 入札</div><div class="hand-area" id="p2-bid"></div><div>計:<span id="p2-sum">0</span></div></div>
        <div class="col-center">
            <div>出品</div>
            <div id="list-p2" class="card back">?</div>
            <div id="list-p1" class="card back">?</div>
            <div style="margin-top:5px">山:<span id="deck-n">0</span></div>
        </div>
        <div class="col-bid"><div>あなた 入札</div><div class="hand-area" id="p1-bid"></div><div>計:<span id="p1-sum">0</span></div></div>
    </div>

    <div id="status-text" style="text-align:center; background:rgba(0,0,0,0.3); padding:5px;">待機中...</div>

    <div style="text-align:center; font-size:0.8rem;">あなたの手札</div>
    <div class="hand-area" id="p1-hand"></div>

    <div id="controls">
        <button class="act-btn" style="background:var(--danger)" onclick="doFold()">降りる</button>
        <button class="act-btn" style="background:var(--primary)" onclick="doAction()">決定</button>
    </div>
    <div id="log"></div>
</div>

<script>
// ■■■ 安全対策: エラー表示機能 ■■■
function showDebug(msg) {
    const el = document.getElementById('debug-msg');
    el.style.display = 'block';
    el.innerText = "エラー: " + msg;
    console.error(msg);
}
window.onerror = function(msg) { showDebug(msg); };

// ■■■ 変数定義 ■■■
let mode = ''; // 'CPU' or 'ONLINE'
let myRole = 'p1';
let db = null;
let roomId = null;
let roomRef = null;
let gs = null; // GameState
let mySel = []; // 選択中のカードインデックス

// ■■■ Firebase設定 ■■■
const firebaseConfig = {
  apiKey: "AIzaSyBID6kYSN3Pp4seo0-c-GiYWQJvx80Zf7s",
  authDomain: "auction-game-b3931.firebaseapp.com",
  projectId: "auction-game-b3931",
  storageBucket: "auction-game-b3931.firebasestorage.app",
  messagingSenderId: "821044018378",
  appId: "1:821044018378:web:1cdb25f16ba4fa2da34833",
  databaseURL: "https://auction-game-b3931-default-rtdb.asia-southeast1.firebasedatabase.app"
};

// 初期化トライ
try {
    if (typeof firebase !== 'undefined') {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        db = firebase.database();
    } else {
        showDebug("Firebase SDKが読み込まれていません(オフライン?)");
    }
} catch(e) {
    showDebug("Firebase初期化失敗: " + e.message);
}

// ■■■ UI操作関数 (ここが動けばボタンは反応する) ■■■
function switchScreen(id) {
    document.querySelectorAll('.screen').forEach(e => e.classList.add('hidden'));
    document.getElementById('container').classList.add('hidden');
    if(id === 'game') document.getElementById('container').classList.remove('hidden');
    else document.getElementById(id).classList.remove('hidden');
}

function startCpuMode() {
    mode = 'CPU';
    myRole = 'p1';
    switchScreen('game');
    document.getElementById('p2-name').innerText = "CPU";
    initGameLocal();
}

function startOnlineMode() {
    if (!db) return alert("オンライン機能が利用できません（エラー表示を確認してください）");
    mode = 'ONLINE';
    switchScreen('screen-lobby');
}

// ■■■ ゲームロジック (CPU) ■■■
function initGameLocal() {
    gs = {
        status: 'bid', deck: makeDeck(),
        p1: { hand: makeHand(), bid: [], list: null, done: false, fold: false },
        p2: { hand: makeHand(), bid: [], list: null, done: false, fold: false },
        msg: '入札してください'
    };
    deal();
    render();
}

function deal() {
    if(gs.deck.length < 2) { gs.status='end'; gs.msg='終了'; render(); return; }
    gs.p1.list = gs.deck.pop();
    gs.p2.list = gs.deck.pop();
    gs.p1.bid = []; gs.p2.bid = [];
    gs.p1.done = false; gs.p2.done = false;
    gs.p1.fold = false; gs.p2.fold = false;
    gs.status = 'bid'; gs.msg = '入札フェーズ';
}

function checkCpu() {
    // CPU思考
    if(gs.status==='bid' && !gs.p2.done) {
        // シンプルAI
        let val = gs.p2.list.val + 7;
        let budget = val > 15 ? 5 : 2;
        let c = gs.p2.hand.find(x => Math.abs(x.val - budget) < 3);
        if(c) {
            gs.p2.bid.push(c);
            gs.p2.hand = gs.p2.hand.filter(x => x!==c);
        } else gs.p2.fold = true;
        gs.p2.done = true;
    }
    // 判定
    if(gs.status==='bid' && gs.p1.done && gs.p2.done) resolve();
    render();
}

function resolve() {
    // 簡易判定
    let s1 = sum(gs.p1.bid), s2 = sum(gs.p2.bid);
    let w = null;
    if(gs.p1.fold) w='p2';
    else if(gs.p2.fold) w='p1';
    else if(s1 > s2) w='p1';
    else if(s2 > s1) w='p2';
    
    gs.msg = w ? (w==='p1'?'あなたの勝ち':'CPUの勝ち') : '引き分け';
    gs.status = 'resolve';
    render();
    
    setTimeout(() => {
        if(w) {
            gs[w].hand.push(gs.p1.list, gs.p2.list); // 賞品
            let l = w==='p1'?'p2':'p1';
            gs[l].hand.push(...gs[l].bid); // 敗者回収
        } else {
             gs.p1.hand.push(...gs.p1.bid);
             gs.p2.hand.push(...gs.p2.bid);
        }
        // ソート
        gs.p1.hand.sort((a,b)=>a.val-b.val);
        gs.p2.hand.sort((a,b)=>a.val-b.val);
        deal();
        render();
    }, 2000);
}

// ■■■ ゲームロジック (Online) ■■■
function createRoom() {
    let id = Math.floor(Math.random()*8999+1000).toString();
    joinRoomLogic(id, 'p1');
}
function joinRoom() {
    let id = document.getElementById('room-id').value;
    if(!id) return alert("IDを入れてください");
    joinRoomLogic(id, 'p2');
}
function joinRoomLogic(id, role) {
    roomId = id; myRole = role;
    roomRef = db.ref('rooms/'+id);
    document.getElementById('lobby-status').innerText = "接続中...";
    
    if(role==='p1') {
        roomRef.set({
            status: 'waiting', deck: makeDeck(),
            p1: {hand: makeHand(), bid:[], list:null, done:false},
            p2: {hand: makeHand(), bid:[], list:null, done:false},
            msg: "待機中 ID: "+id
        });
    }
    
    roomRef.on('value', (s) => {
        let d = s.val();
        if(!d) return document.getElementById('lobby-status').innerText = "部屋がありません";
        gs = d;
        switchScreen('game');
        document.getElementById('p2-name').innerText = "オンライン相手";
        render();
        if(role==='p1') hostLoop();
    });
}

function hostLoop() {
    // ホストのみが進める簡易ループ
    if(gs.status==='waiting' && gs.p2 && gs.p2.connected) { // ※簡易化のため接続判定は省略
        // 本来はここでreadyチェック
    }
    // ※今回はコード量削減のため、オンラインの完全同期ロジックは
    //  前のコードが動かない原因切り分けのため一旦最小限にしています。
    //  まずは「画面が出るか」を確認してください。
}

// ■■■ 共通操作 ■■■
function toggleSel(idx) {
    let i = mySel.indexOf(idx);
    if(i>=0) mySel.splice(i,1); else mySel.push(idx);
    render();
}

function doAction() {
    if(gs.status !== 'bid') return;
    if(mySel.length === 0) return alert("選んでください");
    
    let me = gs[myRole];
    let cards = me.hand.filter((_,i) => mySel.includes(i));
    let left = me.hand.filter((_,i) => !mySel.includes(i));
    
    // 更新データ作成
    let newBid = (me.bid||[]).concat(cards);
    
    if(mode === 'CPU') {
        gs[myRole].hand = left;
        gs[myRole].bid = newBid;
        gs[myRole].done = true;
        checkCpu();
    } else {
        // Online Update
        let u = {};
        u[myRole+'/hand'] = left;
        u[myRole+'/bid'] = newBid;
        u[myRole+'/done'] = true;
        roomRef.update(u);
    }
    mySel = [];
}

function doFold() {
    if(gs.status !== 'bid') return;
    if(!confirm("降りますか？")) return;
    
    if(mode === 'CPU') {
        gs[myRole].fold = true;
        gs[myRole].done = true;
        checkCpu();
    } else {
        roomRef.child(myRole).update({fold:true, done:true});
    }
}

// ■■■ 描画 ■■■
function render() {
    if(!gs) return;
    document.getElementById('status-text').innerText = gs.msg;
    document.getElementById('deck-n').innerText = (gs.deck||[]).length;
    
    let me = gs[myRole];
    let op = gs[myRole==='p1'?'p2':'p1'];
    
    // 出品
    renderCard('list-me', me.list, false);
    let showOp = (gs.status==='resolve' || gs.status==='end');
    renderCard('list-p2', op.list, !showOp);
    
    // 手札
    let hDiv = document.getElementById('p1-hand'); hDiv.innerHTML='';
    (me.hand||[]).forEach((c,i) => {
        let d = document.createElement('div');
        d.className = 'card ' + (mySel.includes(i)?'selected':'');
        d.innerText = c.val;
        d.onclick = () => toggleSel(i);
        hDiv.appendChild(d);
    });
    
    // 相手手札
    let oDiv = document.getElementById('p2-hand'); oDiv.innerHTML='';
    (op.hand||[]).forEach(() => {
        let d = document.createElement('div');
        d.className = 'card back'; d.style.width='30px'; d.style.height='40px';
        oDiv.appendChild(d);
    });
    
    // 入札
    renderBid('p1-bid', me.bid, false);
    document.getElementById('p1-sum').innerText = sum(me.bid);
    
    let hideBid = (gs.status==='bid' && !showOp);
    renderBid('p2-bid', op.bid, hideBid);
    document.getElementById('p2-sum').innerText = hideBid ? '?' : sum(op.bid);
}

function renderCard(id, c, hide) {
    let el = document.getElementById(id);
    if(!c) { el.className='card back'; el.innerText=''; return; }
    el.className = 'card '+(hide?'back':'');
    el.innerText = hide?'?':c.val;
}
function renderBid(id, arr, hide) {
    let el = document.getElementById(id); el.innerHTML='';
    (arr||[]).forEach(c => {
        let d = document.createElement('div');
        d.className = 'card '+(hide?'back':'');
        d.innerText = hide?'?':c.val;
        el.appendChild(d);
    });
}

// Utils
function makeDeck(){ let d=[]; for(let i=0;i<2;i++)for(let v=1;v<=13;v++)d.push({val:v}); return shuffle(d); }
function makeHand(){ let d=[]; for(let v=1;v<=13;v++)d.push({val:v}); return d; }
function shuffle(a){ for(let i=a.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }
function sum(a){ return (a||[]).reduce((t,c)=>t+c.val,0); }

</script>
</body>
</html>
