<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>オークション (Online Fix)</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
/* デザイン設定 */
:root { --bg: #2d5e2e; --primary: #f39c12; --danger: #e74c3c; --blue: #3498db; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background-color: var(--bg); color: white; margin: 0; padding: 0;
    height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
    user-select: none; -webkit-user-select: none; touch-action: manipulation;
}

/* 画面切り替え */
.screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
.hidden { display: none !important; }

/* ボタン・入力 */
h1 { color: var(--primary); font-size: 2.5rem; margin-bottom: 30px; text-shadow: 2px 2px 0 #000; }
.btn-lg { padding: 15px 40px; font-size: 1.2rem; color: white; border: none; border-radius: 50px; margin: 10px; cursor: pointer; width: 80%; max-width: 300px; font-weight: bold; box-shadow: 0 4px 0 rgba(0,0,0,0.4); }
.btn-cpu { background: var(--primary); }
.btn-online { background: var(--blue); }
input { font-size: 1.2rem; padding: 10px; margin: 10px; text-align: center; width: 60%; border-radius: 5px; border: none; }

/* ゲーム画面 */
#game-container { flex: 1; display: flex; flex-direction: column; padding: 5px; box-sizing: border-box; width: 100%; max-width: 600px; margin: 0 auto; }
.area-header { font-size: 0.8rem; opacity: 0.9; text-align: center; margin: 2px 0; }
.card {
    width: 52px; height: 76px; background: white; color: black; border-radius: 5px;
    display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 1.2rem;
    border: 1px solid #999; box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
    cursor: pointer; position: relative; z-index: 1;
}
.card.back { background: repeating-linear-gradient(45deg, #606dbc, #606dbc 10px, #465298 10px, #465298 20px); color: transparent; }
.card.selected { border: 3px solid #f1c40f; transform: translateY(-10px); box-shadow: 0 0 10px #f1c40f; z-index: 10; }
.hand-area { display: flex; gap: 4px; flex-wrap: wrap; justify-content: center; align-content: center; min-height: 90px; padding: 5px 0; }
.field-container { flex: 1; background: rgba(0,0,0,0.15); border-radius: 8px; display: flex; align-items: center; justify-content: space-between; padding: 5px; margin: 5px 0; }
.bid-col { width: 42%; display: flex; flex-direction: column; align-items: center; }
.bid-cards { display: flex; gap: 2px; flex-wrap: wrap; justify-content: center; min-height: 40px; }
.center-col { width: 16%; display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; }
#status-bar { background: rgba(0,0,0,0.3); text-align: center; padding: 5px; font-size: 0.85rem; font-weight: bold; border-radius: 4px; margin-bottom: 5px; }
#log-area { height: 60px; overflow-y: auto; background: rgba(0,0,0,0.4); font-size: 0.75rem; padding: 5px; border-radius: 4px; }
.log-turn { color: #f1c40f; } .log-sys { color: #bdc3c7; }
#controls { display: flex; gap: 10px; padding: 5px; justify-content: center; }
button { flex: 1; padding: 12px; border: none; border-radius: 5px; font-size: 1rem; font-weight: bold; color: white; cursor: pointer; }
#btn-act { background: var(--primary); } #btn-fold { background: var(--danger); }
button:disabled { background: #7f8c8d; opacity: 0.5; }
#back-btn { position: absolute; top: 5px; left: 5px; padding: 5px 10px; font-size: 0.8rem; background: rgba(0,0,0,0.5); width: auto; flex: none; z-index: 50; }

#modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
#modal h2 { color: #f1c40f; font-size: 2rem; margin-bottom: 20px; }
#modal p { font-size: 1.2rem; line-height: 1.6; text-align: center; margin-bottom: 30px; }
#btn-retry { background: #3498db; width: auto; padding: 10px 40px; }
</style>
</head>
<body>

<div id="screen-title" class="screen">
    <h1>AUCTION</h1>
    <button class="btn-lg btn-cpu" onclick="modeSelect('CPU')">ひとりで遊ぶ</button>
    <button class="btn-lg btn-online" onclick="modeSelect('ONLINE')">友達と遊ぶ</button>
</div>

<div id="screen-lobby" class="screen hidden">
    <h2>オンライン対戦</h2>
    <input type="text" id="room-id-input" placeholder="部屋ID (例: 1234)">
    <div>
        <button class="btn-lg btn-cpu" onclick="createRoom()">部屋を作る</button>
        <button class="btn-lg btn-online" onclick="joinRoom()">部屋に入る</button>
    </div>
    <p id="lobby-msg" style="color: #f1c40f; margin-top: 20px;"></p>
    <button onclick="location.reload()" style="background:none; border:1px solid #fff; width:auto; padding:5px 20px; margin-top:20px;">戻る</button>
</div>

<div id="game-container" class="hidden">
    <button id="back-btn" onclick="location.reload()">TOP</button>
    <div>
        <div class="area-header"><span id="opp-name">CPU</span> (手札: <span id="cpu-cnt">13</span>)</div>
        <div class="hand-area" id="cpu-hand"></div>
    </div>

    <div class="field-container">
        <div class="bid-col">
            <div class="area-header"><span id="opp-label">CPU</span> 入札</div>
            <div class="bid-cards" id="cpu-bid"></div>
            <div class="area-header">計: <span id="cpu-sum">0</span></div>
        </div>
        <div class="center-col">
            <div class="area-header">出品</div>
            <div style="display:flex; flex-direction:column; gap:5px; margin: 5px 0;">
                <div id="lst-cpu" class="card back" style="width:36px; height:50px;">?</div>
                <div id="lst-plr" class="card back" style="width:36px; height:50px;">?</div>
            </div>
            <div class="area-header">山: <span id="deck-n">26</span></div>
        </div>
        <div class="bid-col">
            <div class="area-header">あなた 入札</div>
            <div class="bid-cards" id="plr-bid"></div>
            <div class="area-header">計: <span id="plr-sum">0</span></div>
        </div>
    </div>

    <div id="status-bar">準備中...</div>
    
    <div>
        <div class="area-header">あなたの手札 (タップで選択)</div>
        <div class="hand-area" id="plr-hand"></div>
    </div>

    <div id="controls">
        <button id="btn-fold" onclick="fold()">降りる</button>
        <button id="btn-act" onclick="action()">入札する</button>
    </div>
    
    <div id="log-area"></div>
</div>

<div id="modal">
    <h2>ゲーム終了</h2>
    <p id="modal-msg"></p>
    <button id="btn-retry" onclick="resetGame()">もう一度遊ぶ</button>
</div>

<script>
// ■■■ Firebase 設定 ■■■
const firebaseConfig = {
  apiKey: "AIzaSyBID6kYSN3Pp4seo0-c-GiYWQJvx80Zf7s",
  authDomain: "auction-game-b3931.firebaseapp.com",
  projectId: "auction-game-b3931",
  storageBucket: "auction-game-b3931.firebasestorage.app",
  messagingSenderId: "821044018378",
  appId: "1:821044018378:web:1cdb25f16ba4fa2da34833",
  databaseURL: "https://auction-game-b3931-default-rtdb.asia-southeast1.firebasedatabase.app"
};

let db = null;
try {
    if (typeof firebase !== 'undefined') {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        db = firebase.database();
    }
} catch(e) { console.error("Firebase Init Error", e); }

// ■■■ ゲーム変数 ■■■
let deck = [], pHand = [], cHand = [];
let pList = null, cList = null;
let pBid = [], cBid = [];
let pSelect = [];
let phase = 'SETUP';
let turn = null;
let tieCount = 0;

// モード管理
let gameMode = ''; // 'CPU' or 'ONLINE'
let myRole = 'p1'; // Online: 'p1'(Host) or 'p2'(Guest)
let roomId = null;
let roomRef = null;

// UI要素
const ui = {
    cCnt: document.getElementById('cpu-cnt'),
    cHand: document.getElementById('cpu-hand'),
    cBid: document.getElementById('cpu-bid'),
    cSum: document.getElementById('cpu-sum'),
    lCpu: document.getElementById('lst-cpu'),
    lPlr: document.getElementById('lst-plr'),
    deckN: document.getElementById('deck-n'),
    pBid: document.getElementById('plr-bid'),
    pSum: document.getElementById('plr-sum'),
    pHand: document.getElementById('plr-hand'),
    status: document.getElementById('status-bar'),
    btnAct: document.getElementById('btn-act'),
    btnFold: document.getElementById('btn-fold'),
    log: document.getElementById('log-area'),
    modal: document.getElementById('modal'),
    modalMsg: document.getElementById('modal-msg'),
    oppName: document.getElementById('opp-name'),
    oppLabel: document.getElementById('opp-label')
};

// ■■■ 画面遷移 ■■■
function showScreen(id) {
    document.querySelectorAll('.screen').forEach(e => e.classList.add('hidden'));
    document.getElementById('game-container').classList.add('hidden');
    if(id === 'game') document.getElementById('game-container').classList.remove('hidden');
    else document.getElementById(id).classList.remove('hidden');
}

function modeSelect(m) {
    gameMode = m;
    if (m === 'ONLINE') {
        if(!db) return alert("通信エラー: Firebaseが読み込まれていません");
        showScreen('screen-lobby');
    } else {
        myRole = 'p1';
        ui.oppName.innerText = "CPU";
        ui.oppLabel.innerText = "CPU";
        showScreen('game');
        init();
    }
}

// ■■■ 初期化 ■■■
function init() {
    deck = [];
    for(let i=0; i<2; i++) for(let v=1; v<=13; v++) deck.push({ val: v });
    shuffle(deck);
    pHand = []; cHand = [];
    for(let v=1; v<=13; v++) { pHand.push({ val: v }); cHand.push({ val: v }); }

    ui.modal.style.display = 'none';
    ui.log.innerHTML = '';
    
    if(gameMode === 'ONLINE' && myRole === 'p1') {
        hostSyncAll(); // ホストが初期状態送信
    }
    
    startRound();
}

function resetGame() { init(); }

function startRound() {
    pList = null; cList = null;
    pBid = []; cBid = [];
    pSelect = [];
    tieCount = 0;
    turn = null;

    if(deck.length < 2) { endGame(); return; }

    phase = 'LISTING';
    cList = deck.pop();
    pList = deck.pop();
    
    log("--- 新しいラウンド ---", "sys");
    updateView();

    setTimeout(() => {
        phase = 'BID';
        ui.status.innerText = "入札フェーズ: カードを選んでください";
        updateView();
        if(gameMode === 'ONLINE' && myRole === 'p1') hostSyncAll();
    }, 800);
}

// ■■■ アクション ■■■
function toggleCard(index) {
    if(phase !== 'BID' && phase !== 'COMPARE') return;
    if(phase === 'COMPARE' && turn !== 'PLAYER') return;
    const selIdx = pSelect.indexOf(index);
    if(selIdx >= 0) pSelect.splice(selIdx, 1);
    else pSelect.push(index);
    updateView();
}

function action() {
    if(pSelect.length === 0) return alert("カードを選んでください");
    
    // カード移動
    pSelect.sort((a,b) => b - a);
    let selectedCards = [];
    pSelect.forEach(idx => {
        selectedCards.push(pHand[idx]);
        pHand.splice(idx, 1);
    });
    selectedCards.reverse();
    pSelect = [];

    const addVal = sum(selectedCards);
    if(phase === 'COMPARE') {
        const currentP = sum(pBid);
        const currentC = sum(cBid);
        if(currentP + addVal <= currentC) {
            pHand.push(...selectedCards);
            pHand.sort((a,b) => a.val - b.val);
            updateView();
            return alert(`相手(${currentC})を上回る必要があります`);
        }
    }

    pBid = [...pBid, ...selectedCards];
    
    if(phase === 'BID') {
        log(`あなた: 入札 (伏せ)`, "turn");
        if(gameMode === 'CPU') {
            cpuSimultaneousBid();
            resolveSimultaneous();
        } else {
            // Online: 自分のBidだけ送信
            guestSendAction();
        }
    } else {
        log(`あなた: 追加 +${addVal} (計${sum(pBid)})`, "turn");
        if(gameMode === 'CPU') checkComparison();
        else guestSendAction();
    }
}

function fold() {
    log("あなた: 降り", "turn");
    if(gameMode === 'CPU') {
        if(phase === 'BID') {
            const cpuAction = cpuDecideSimultaneous();
            if(cpuAction.type === 'FOLD') {
                log("両者降り。不成立。", "sys");
                discardLists(); returnBids(); startRound();
            } else {
                cBid = removeCards(cHand, cpuAction.cards);
                resolveWin('CPU');
            }
        } else {
            resolveWin('CPU');
        }
    } else {
        // Online: 降りフラグを送る(簡易: Bidを空でDone)
        // 厳密にはFoldフラグが良いが、今回は簡易同期のため特殊処理
        guestSendFold();
    }
}

// ■■■ 進行ロジック ■■■
function resolveSimultaneous() {
    updateView();
    if(cBid.length === 0 && gameMode === 'CPU') {
        log("CPU: 降り", "sys"); resolveWin('PLAYER'); return;
    }
    checkComparison();
}

function checkComparison() {
    phase = 'COMPARE';
    const ps = sum(pBid);
    const cs = sum(cBid);
    updateView();
    
    if(gameMode === 'ONLINE' && myRole === 'p1') hostSyncAll();

    if(ps === cs) {
        log(`同点(${ps})。同時追加へ`, "sys");
        tieCount++;
        if(tieCount >= 3) {
            log("3回同点のため不成立", "sys");
            discardLists(); returnBids(); startRound(); return;
        }
        setTimeout(() => {
            phase = 'BID';
            ui.status.innerText = "同点：追加カードを選んでください";
            updateView();
            if(gameMode === 'ONLINE' && myRole === 'p1') hostSyncAll();
        }, 1000);
    } else if(ps > cs) {
        turn = 'CPU'; // CPU or 相手
        ui.status.innerText = "相手のターン...";
        updateView();
        if(gameMode === 'CPU') setTimeout(cpuTurnComparison, 1000);
    } else {
        turn = 'PLAYER';
        ui.status.innerText = "相手より小さいです。追加か降りを";
        updateView();
    }
}

function resolveWin(winner) {
    phase = 'RESOLVE';
    ui.lPlr.classList.remove('back'); ui.lPlr.innerText = pList.val;
    ui.lCpu.classList.remove('back'); ui.lCpu.innerText = cList.val;
    log(`勝者: ${winner === 'PLAYER' ? 'あなた' : '相手'}`, "sys");

    if(gameMode === 'ONLINE' && myRole === 'p1') hostSyncAll();

    setTimeout(() => {
        const pot = [pList, cList];
        if(winner === 'PLAYER') { pHand.push(...pot); cHand.push(...cBid); }
        else { cHand.push(...pot); pHand.push(...pBid); }
        pHand.sort((a,b) => a.val - b.val); cHand.sort((a,b) => a.val - b.val);
        startRound();
    }, 2500);
}

function discardLists() { pList = null; cList = null; }
function returnBids() {
    pHand.push(...pBid); cHand.push(...cBid);
    pHand.sort((a,b) => a.val - b.val); cHand.sort((a,b) => a.val - b.val);
}
function endGame() {
    phase = 'END';
    const ps = sum(pHand); const cs = sum(cHand);
    let msg = `あなた: ${ps}点<br>相手: ${cs}点<br><br>`;
    if(ps > cs) msg += "あなたの勝利！";
    else if(cs > ps) msg += "相手の勝利...";
    else msg += "引き分け";
    ui.modalMsg.innerHTML = msg; ui.modal.style.display = 'flex';
    if(gameMode === 'ONLINE' && myRole === 'p1') hostSyncAll();
}

// ■■■ CPU AI ■■■
function cpuSimultaneousBid() {
    const d = cpuDecideSimultaneous();
    if(d.type === 'BID') cBid = [...cBid, ...removeCards(cHand, d.cards)];
}
function cpuDecideSimultaneous() {
    const pot = cList.val + 7;
    const bdg = pot > 20 ? 8 : (pot > 15 ? 5 : 2);
    if(pot < 5 && Math.random() > 0.8) return { type: 'FOLD' };
    let best = -1, min = 99;
    for(let i=0; i<cHand.length; i++) {
        let d = Math.abs(cHand[i].val - bdg);
        if(d < min) { min = d; best = cHand[i].val; }
    }
    if(best !== -1) return { type: 'BID', cards: [best] };
    return { type: 'FOLD' };
}
function cpuTurnComparison() {
    const diff = sum(pBid) - sum(cBid);
    const pot = cList.val + 7;
    if(sum(cBid) + diff + 1 > pot && Math.random() > 0.3) {
        log("CPU: 降り", "sys"); resolveWin('PLAYER'); return;
    }
    let cands = cHand.filter(c => c.val > diff);
    if(cands.length === 0) { log("CPU: 降り(手札なし)", "sys"); resolveWin('PLAYER'); return; }
    cands.sort((a,b) => a.val - b.val);
    const c = cands[0];
    cBid.push(...removeCards(cHand, [c.val]));
    log(`CPU: 追加 +${c.val}`, "sys");
    checkComparison();
}

// ■■■ Online Logic (Fix) ■■■
function createRoom() {
    const id = Math.floor(1000 + Math.random() * 9000).toString();
    initRoom(id, 'p1');
}
function joinRoom() {
    const id = document.getElementById('room-id-input').value;
    if(!id) return alert("IDを入力してください");
    initRoom(id, 'p2');
}
function initRoom(id, role) {
    roomId = id; myRole = role;
    roomRef = db.ref('rooms/' + roomId);
    document.getElementById('lobby-msg').innerText = "接続中...";
    
    if(role === 'p1') {
        ui.oppName.innerText = "Guest"; ui.oppLabel.innerText = "Guest";
        showScreen('game');
        init();
    } else {
        roomRef.get().then(s => {
            if(!s.exists()) return alert("部屋がありません");
            myRole = 'p2';
            ui.oppName.innerText = "Host"; ui.oppLabel.innerText = "Host";
            showScreen('game');
            roomRef.on('value', onGuestSync);
        });
    }
}

// Host: 全権限を持つ
function hostSyncAll() {
    if(!roomRef) return;
    roomRef.update({
        deck: deck, phase: phase, turn: turn,
        p1_hand: pHand, p1_bid: pBid, p1_list: pList,
        p2_hand: cHand, p2_bid: cBid, p2_list: cList // Host視点のp2=Guest
    });
    // HostもListener登録して、Guestの入札を検知
    roomRef.on('value', onHostSync);
}

// Guest: 自分のアクションのみ送信 (部分更新)
function guestSendAction() {
    if(!roomRef) return;
    // Guest視点のpHandは、Server上のp2_hand
    roomRef.update({
        p2_hand: pHand,
        p2_bid: pBid,
        p2_action: Date.now() // アクション検知用トリガー
    });
}
function guestSendFold() {
    if(!roomRef) return;
    roomRef.update({
        p2_fold: true,
        p2_action: Date.now()
    });
}

// Host側受信: Guestの動きを取り込む
function onHostSync(snap) {
    const val = snap.val();
    if(!val) return;
    
    // Guestが入札・アクションしたか？
    // local cHand/cBid を更新
    if(val.p2_hand) cHand = val.p2_hand;
    if(val.p2_bid) cBid = val.p2_bid;
    
    // Fold判定
    if(val.p2_fold) {
        roomRef.update({ p2_fold: null }); // フラグリセット
        log("相手: 降り", "turn");
        resolveWin('PLAYER'); // Host勝ち
        return;
    }

    // 同時入札の解決
    if(phase === 'BID' && pBid.length > 0 && cBid.length > 0) {
        resolveSimultaneous();
    }
    // 比較フェーズの解決
    else if(phase === 'COMPARE' && turn === 'CPU') { // CPU=GuestTurn
        // Guestが動いた形跡(cBid増えたなど)があればチェック
        checkComparison();
    }
    
    updateView();
}

// Guest側受信: Hostの決定に従う
function onGuestSync(snap) {
    const val = snap.val();
    if(!val) return;

    // HostのデータをLocalに反映
    if(val.deck) deck = val.deck;
    if(val.phase) phase = val.phase;
    if(val.turn) turn = val.turn;
    
    // Hostの手札(p1) -> Local cHand
    if(val.p1_hand) cHand = val.p1_hand;
    if(val.p1_bid) cBid = val.p1_bid;
    if(val.p1_list) cList = val.p1_list;
    
    // Guestの手札(p2) -> Local pHand
    // ★重要: 自分が操作中は上書きしない制御が必要だが、今回はHost絶対主義で上書き
    if(val.p2_hand) pHand = val.p2_hand;
    if(val.p2_bid) pBid = val.p2_bid;
    if(val.p2_list) pList = val.p2_list;
    
    // 勝敗表示など
    if(phase === 'RESOLVE' && val.phase === 'RESOLVE') {
        // Host側で処理が進むので、Guestは見るだけ
    }

    updateView();
}

// ■■■ Utils ■■■
function shuffle(arr) { for(let i=arr.length-1; i>0; i--) { const j=Math.floor(Math.random()*(i+1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } }
function sum(cards) { return (cards||[]).reduce((a,b) => a + b.val, 0); }
function removeCards(hand, vals) {
    let ret = [];
    vals.forEach(v => { const i = hand.findIndex(c => c.val === v); if(i !== -1) { ret.push(hand[i]); hand.splice(i, 1); } });
    return ret;
}
function log(msg, type) {
    const d = document.createElement('div'); d.className = type === 'turn' ? 'log-turn' : 'log-sys'; d.innerText = msg;
    ui.log.prepend(d);
}
function updateView() {
    ui.deckN.innerText = deck.length; ui.cCnt.innerText = cHand.length;
    ui.cHand.innerHTML = '';
    cHand.forEach(() => { const d = document.createElement('div'); d.className = 'card back'; d.style.width = '25px'; d.style.height = '38px'; ui.cHand.appendChild(d); });
    ui.pHand.innerHTML = '';
    pHand.forEach((c, i) => { const d = document.createElement('div'); d.className = 'card' + (pSelect.includes(i) ? ' selected' : ''); d.innerText = c.val; d.onclick = () => toggleCard(i); ui.pHand.appendChild(d); });
    renderCards(ui.pBid, pBid, false); ui.pSum.innerText = sum(pBid);
    const hideCpu = (phase === 'BID'); renderCards(ui.cBid, cBid, hideCpu); ui.cSum.innerText = hideCpu ? '?' : sum(cBid);
    if(pList) { ui.lPlr.innerText = pList.val; ui.lPlr.classList.remove('back'); } else ui.lPlr.innerText = '';
    if(cList) { if(phase === 'RESOLVE') { ui.lCpu.innerText = cList.val; ui.lCpu.classList.remove('back'); } else { ui.lCpu.innerText = '?'; ui.lCpu.classList.add('back'); } } else ui.lCpu.innerText = '';
    const isMyTurn = (phase === 'BID') || (phase === 'COMPARE' && turn === 'PLAYER');
    ui.btnAct.disabled = !isMyTurn; ui.btnFold.disabled = !isMyTurn;
    ui.btnAct.innerText = phase === 'BID' ? '入札' : '追加';
    ui.status.style.background = isMyTurn ? 'rgba(243, 156, 18, 0.4)' : 'rgba(0,0,0,0.3)';
}
function renderCards(el, cards, hidden) {
    el.innerHTML = ''; (cards||[]).forEach(c => { const d = document.createElement('div'); d.className = 'card ' + (hidden ? 'back' : ''); d.innerText = hidden ? '?' : c.val; d.style.width = '36px'; d.style.height = '50px'; d.style.fontSize = '1rem'; el.appendChild(d); });
}
</script>
</body>
</html>
